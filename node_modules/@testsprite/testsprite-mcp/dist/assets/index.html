<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Upload File</title>
    <link rel="stylesheet" href="font.css">
    <link rel="stylesheet" href="main.css">
</head>

<body>
<div class="root">
    <div class="header">
        <img src="img/logo.svg" class="logo" alt="logo" />
    </div>

    <div class="container py60">
        <form id="form" class="form">
            <h1 class="Semi-bold-headline-30 Fg-default">Testing Configuration</h1>
            <h2 class="tooltip-label Medium-body-16 Fg-default mt40">Testing Types <span class="Fg-error">*</span> <span class="tooltip" id="tooltip-type">Testing Types Required</span></h2>
            <p class="Regular-body-14 Fg-secondary mt2">Select your testing types.</p>

            <div class="block mt10">
                <div class="field-line">
                    <div class="field-label">Mode</div>

                    <div class="field-body">
                        <div class="tabs" id="tab-mode">
                            <div class="tabs-content">
                                <div class="current" role="button" data-value="Backend">Backend</div>
                                <div role="button" data-value="Frontend">Frontend</div>
                            </div>
                        </div>

                        <p class="field-tip">Choose whether to test your backend service or frontend workflows.</p>
                    </div>
                </div>

                <hr class="split"/>

                <div class="field-line">
                    <div class="field-label">Scope</div>

                    <div class="field-body">
                        <div class="tabs" id="tab-scope">
                            <div class="tabs-content">
                                <div class="current" role="button" data-value="codebase">Codebase</div>
                                <div role="button" data-value="diff">Code diff</div>
                            </div>
                        </div>

                        <p class="field-tip">Select whether to test against the entire codebase or just recent changes (uncommitted git changes).</p>
                    </div>
                </div>
            </div>


            <div class="line-backend-authentication">
                <h2 class="tooltip-label Medium-body-16 Fg-default mt30">Authentication <span class="Fg-error">*</span> <span class="tooltip" id="tooltip-authentication">Authentication Required</span></h2>
                <p class="Regular-body-14 Fg-secondary mt2">Select how your backend server authenticates incoming requests.</p>

                <div class="block mt10">
                    <div class="field-line">
                        <label class="field-label" for="backendAuthType">Type</label>

                        <div class="field-body">
                            <select class="select" id="backendAuthType">
                                <option value="basic token">Basic - Uses username & password</option>
                                <option value="Bearer token">Bearer - Secure token-based authentication</option>
                                <option value="API key">API-key - Uses a unique API key for access</option>
                                <option value="public">None - No authentication required</option>
                            </select>

                            <p class="field-tip" id="tip-type"></p>
                        </div>
                    </div>


                    <div class="field-line mt20" id="form-item-credential">
                        <label class="field-label" for="backendCredential">Credential</label>

                        <div class="field-body">
                            <input class="input" id="backendCredential" />
                            <p class="field-tip">Enter your bearer token (e.g., eyJhbGciOiJIUzI1NiIsInR5cCI6...).</p>
                        </div>
                    </div>


                    <div class="field-line mt20" id="form-item-api-key">
                        <label class="field-label" for="backendApiKey">Key</label>

                        <div class="field-body">
                            <input class="input" id="backendApiKey" />
                            <p class="field-tip">Enter the name of the header used for the API key (e.g., x-api-key).</p>
                        </div>
                    </div>

                    <div class="field-line mt20" id="form-item-api-value">
                        <label class="field-label" for="backendApiValue">Value</label>

                        <div class="field-body">
                            <input class="input" id="backendApiValue" />
                            <p class="field-tip">Enter the value of the API key provided by your server (e.g., 12345-abcde-67890).</p>
                        </div>
                    </div>

                    <div class="field-line mt20" id="form-item-username">
                        <label class="field-label" for="backendUsername">Username</label>

                        <div class="field-body">
                            <input class="input" id="backendUsername" />
                            <p class="field-tip">Enter the test account’s username used for your server.</p>
                        </div>
                    </div>

                    <div class="field-line mt20" id="form-item-password">
                        <label class="field-label" for="backendPassword">Password</label>

                        <div class="field-body">
                            <input class="input" id="backendPassword" />
                            <p class="field-tip">Enter the corresponding password for that test account.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="line-account">
                <h2 class="Medium-body-16 Fg-default mt30">Test Account Info <span class="Fg-secondary">(Optional)</span></h2>
                <p class="Regular-body-14 Fg-secondary mt2">Provide the login credentials for a test account that can be used to access and test your application.</p>

                <div class="block mt10">
                    <div class="field-line">
                        <label class="field-label" for="login_user">Test Account Username</label>

                        <div class="field-body">
                            <input type="text" name="login_user" class="input" id="login_user">
                            <p class="field-tip">Provide a test account username, e.g., test@example.com.</p>
                        </div>
                    </div>

                    <div class="field-line mt20">
                        <label class="field-label" for="login_password">Test Account Password</label>

                        <div class="field-body">
                            <input type="password" name="login_password" class="input" id="login_password">
                            <p class="field-tip">Enter the corresponding password for the test account, e.g., 123456abc.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="line-url">
                <h2 class="tooltip-label Medium-body-16 Fg-default mt30">Local Development Port <span class="Fg-error">*</span> <span class="tooltip" id="tooltip-port">Local Development Port Required</span></h2>
                <p class="Regular-body-14 Fg-secondary mt2">Port where your local dev server is running e.g. 3000 in localhost:3000. If there is a specific path that you want to test and not accessible from the root, enter it in the "Path" section. e.g. dashboard for localhost:3000/dashboard</p>

                <div class="block mt10">
                    <div class="field-line">
                        <label class="field-label">Port</label>
                        <div class="field-body">
                            <div class="line-url-content">
                                <label>
                                    <span>http://localhost:</span>
                                    <input type="text" name="port" class="input" inputmode="numeric" pattern="[0-9]*" maxlength="5"/>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="field-line mt20">
                        <label class="field-label">Path</label>
                        <div class="field-body">
                            <div class="line-url-content">
                                <label>
                                    <span>/</span>
                                    <input type="text" name="pathname" class="input"/>
                                </label>
                            </div>
                        </div>
                    </div>
                    <p class="field-tip2 mt20">
                        <img src="./img/exclamation-circle.svg" alt="icon"/>
                        Please ensure your server is running and reachable.</p>
                </div>
            </div>

            <div class="line-file mt30">
                <div class="tooltip-label Medium-body-16 Fg-default ">Product Specification Doc <span class="Fg-error">*</span> <span class="tooltip" id="tooltip-files">Product Spec Required</span></div>
                <p class="Regular-body-14 Fg-secondary mt2">Upload a document that explains your desired product’s features, purpose, and how it should work.</p>

                <div class="file-picker">
                    <div class="file-container">
                        <div class="file-picker-tips">
                            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjUiIHZpZXdCb3g9IjAgMCA2NCA2NSIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTI0LjM4OCAxMy42NDU0QzI0Ljk2NCAxNC4yMjE0IDI1LjI4NzUgMTUuMDAyNSAyNS4yODc1IDE1LjgxN1YxNi42NTkxSDQ0Ljg1MzdDNDUuNjY4MiAxNi42NTkxIDQ2LjQ0OTQgMTYuOTgyNyA0Ny4wMjUzIDE3LjU1ODZMNDkuMDg5MyAxOS45Mjg0QzQ5LjU4MjQgMjAuNDg3NyA0OS44NTY3IDIxLjIwOTMgNDkuODU2NyAyMS45NTkzVjI1Ljg3MjVINTAuOTk2QzUxLjQ2NjcgMjUuODcyNCA1MS45MzEyIDI1Ljk4MDQgNTIuMzUzNiAyNi4xODg0TDU0LjgxMDUgMjguNzQ1NUM1NS4wMTcyIDI4LjkwNTggNTUuMjAzMiAyOS4wOTIyIDU1LjM2MzYgMjkuMzAwOUM1NS42NTA1IDI5LjY3NDEgNTUuODQ3OCAzMC4xMDgyIDU1Ljk0MDIgMzAuNTY5OUM1Ni4wMzI3IDMxLjAzMTUgNTYuMDE3NyAzMS41MDgxIDU1Ljg5NjYgMzEuOTYzTDUxLjM5MjIgNTAuMzg5OUM1MS4yMTggNTEuMDQ0MSA1MC44MzI1IDUxLjYyMjUgNTAuMjk1NiA1Mi4wMzVDNDkuNzU4NyA1Mi40NDc0IDQ5LjEwMDUgNTIuNjcwOSA0OC40MjM1IDUyLjY3MDdMMTMuNDE4OSA1Mi42MjI2QzEzLjQxMTIgNTIuNjIyNiAxMy40MDM1IDUyLjYyMjYgMTMuMzk1OCA1Mi42MjI2QzEzLjI1MDQgNTIuNjIxOSAxMy4xMDQ2IDUyLjYxMjEgMTIuOTU5IDUyLjU5M0MxMi4xMjk4IDUyLjQ4NDEgMTEuMzY3NSA1Mi4wODAzIDEwLjgxMTYgNTEuNDU1NEw5Ljg0NTY3IDUwLjM0MDlMOC44Nzk3NSA0OS4yMjY0QzguMzIzODUgNDguNjAxNSA4LjAxMTU2IDQ3Ljc5NzMgOCA0Ni45NjFWMTMuNTg4QzggMTIuNzczNSA4LjMyMzU3IDExLjk5MjMgOC44OTk1MiAxMS40MTY0QzkuNDc1NDcgMTAuODQwNCAxMC4yNTY2IDEwLjUxNjggMTEuMDcxMSAxMC41MTY4SDIwLjI4NDZDMjEuMDk5MSAxMC41MTY4IDIxLjg4MDIgMTAuODQwNCAyMi40NTYyIDExLjQxNjRMMjQuMzg4IDEzLjY0NTRaIiBmaWxsPSIjMjEyMjI0Ii8+CjxwYXRoIGQ9Ik0yNC4zODggMTMuNjQ1NEMyNC45NjQgMTQuMjIxNCAyNS4yODc1IDE1LjAwMjUgMjUuMjg3NSAxNS44MTdWMTYuNjU5MU0yNC4zODggMTMuNjQ1NEMyMy44MTIxIDEzLjA2OTUgMjMuMDMwOSAxMi43NDU5IDIyLjIxNjQgMTIuNzQ1OUgxMy4wMDNDMTIuMjU4OCAxMi43NDU5IDExLjU0MjUgMTMuMDE2IDEwLjk4NTEgMTMuNTAxOU0yNC4zODggMTMuNjQ1NEwyMi40NTYyIDExLjQxNjRDMjEuODgwMiAxMC44NDA0IDIxLjA5OTEgMTAuNTE2OCAyMC4yODQ2IDEwLjUxNjhIMTEuMDcxMUMxMC4yNTY2IDEwLjUxNjggOS40NzU0NyAxMC44NDA0IDguODk5NTIgMTEuNDE2NE0yMi42ODIzIDI4LjcxNTRDMjIuMTQ5OSAyOS4xMTQ2IDIxLjc2MTQgMjkuNjc1OSAyMS41NzU2IDMwLjMxNDlMMTYuNzYyMSA1MC4wODY5QzE2LjUzNSA1MC44OTE4IDE2LjAyNTcgNTEuNTg4MSAxNS4zMjc0IDUyLjA0ODNDMTQuNjI5IDUyLjUwODUgMTMuNzg4MyA1Mi43MDE5IDEyLjk1OSA1Mi41OTNDMTIuMTI5OCA1Mi40ODQxIDExLjM2NzUgNTIuMDgwMyAxMC44MTE2IDUxLjQ1NTRMOS44NDU2NyA1MC4zNDA5TDguODc5NzQgNDkuMjI2NEM4LjMyMzg1IDQ4LjYwMTUgOC4wMTE1NiA0Ny43OTczIDggNDYuOTYxVjEzLjU4OEM4IDEyLjc3MzUgOC4zMjM1NyAxMS45OTIzIDguODk5NTIgMTEuNDE2NE0yMi42ODIzIDI4LjcxNTRDMjMuMjE0OCAyOC4zMTYzIDIzLjg2MjUgMjguMTAwOCAyNC41MjggMjguMTAxNkg1Mi45Mjc4QzUzLjM5ODYgMjguMTAxNCA1My44NjMxIDI4LjIwOTUgNTQuMjg1NCAyOC40MTc0QzU0LjQ3MTcgMjguNTA5MSA1NC42NDc1IDI4LjYxOTIgNTQuODEwNSAyOC43NDU1TTIyLjY4MjMgMjguNzE1NEwyMC43NTA1IDI2LjQ4NjRNMTMuMzk1NSA1Mi42MjI2TDQ4LjQyMzUgNTIuNjcwN0M0OS4xMDA1IDUyLjY3MDkgNDkuNzU4NyA1Mi40NDc0IDUwLjI5NTYgNTIuMDM1QzUwLjgzMjUgNTEuNjIyNSA1MS4yMTggNTEuMDQ0MSA1MS4zOTIyIDUwLjM4OTlMNTUuODk2NiAzMS45NjNDNTYuMDE3NyAzMS41MDgxIDU2LjAzMjcgMzEuMDMxNSA1NS45NDAyIDMwLjU2OTlDNTUuODQ3OCAzMC4xMDgyIDU1LjY1MDUgMjkuNjc0MSA1NS4zNjM2IDI5LjMwMDlDNTUuMjAzMiAyOS4wOTIyIDU1LjAxNzIgMjguOTA1OCA1NC44MTA1IDI4Ljc0NTVNOC44OTk1MiAxMS40MTY0TDEwLjk4NTEgMTMuNTAxOU0yMC43NTA1IDI2LjQ4NjRDMjAuMjE4IDI2Ljg4NTUgMTkuODI5NiAyNy40NDY4IDE5LjY0MzcgMjguMDg1OEwxNC44MzAyIDQ3Ljg1NzhDMTQuNjAzMiA0OC42NjI4IDE0LjA5MzkgNDkuMzU5IDEzLjM5NTUgNDkuODE5M0MxMi4zMjI2IDUwLjExMzkgMTEuMzA0NCA0OS4wMDMgMTAuODExNiA0OC41NTk0QzkuOTE5OTcgNDguMDY0IDkuNzIxODMgNDcuMDQwMyA5LjcyMTgzIDQ2LjY2MzhMOS45MzE4NSAxNS44MTdDOS45MzE4NSAxNS4wMDI1IDEwLjI1NTQgMTQuMjIxNCAxMC44MzE0IDEzLjY0NTRDMTAuODgxMSAxMy41OTU3IDEwLjkzMjQgMTMuNTQ3OCAxMC45ODUxIDEzLjUwMTlNMjAuNzUwNSAyNi40ODY0QzIxLjI4MjkgMjYuMDg3MiAyMS45MzA2IDI1Ljg3MTggMjIuNTk2MSAyNS44NzI1SDQ5Ljg1NjdNNDkuMDg5MyAxOS45Mjg0QzQ5LjU4MjQgMjAuNDg3NyA0OS44NTY3IDIxLjIwOTMgNDkuODU2NyAyMS45NTkzVjI1Ljg3MjVNNDkuMDg5MyAxOS45Mjg0QzQ5LjA0NjkgMTkuODgwMyA0OS4wMDI4IDE5LjgzMzMgNDguOTU3MSAxOS43ODc3QzQ4LjM4MTIgMTkuMjExNyA0Ny42IDE4Ljg4ODIgNDYuNzg1NSAxOC44ODgySDI1LjI4NzVWMTYuNjU5MU00OS4wODkzIDE5LjkyODRMNDcuMDI1MyAxNy41NTg2QzQ2LjQ0OTQgMTYuOTgyNyA0NS42NjgyIDE2LjY1OTEgNDQuODUzNyAxNi42NTkxSDI1LjI4NzVNNDkuODU2NyAyNS44NzI1SDUwLjk5NkM1MS40NjY3IDI1Ljg3MjQgNTEuOTMxMiAyNS45ODA0IDUyLjM1MzYgMjYuMTg4NEw1NC44MTA1IDI4Ljc0NTUiIHN0cm9rZT0iIzNDM0MzRCIgc3Ryb2tlLXdpZHRoPSIwLjgiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8cGF0aCBkPSJNNDguOTU3MSAxOS43ODc3QzQ5LjAwMjggMTkuODMzMyA0OS4wNDY5IDE5Ljg4MDMgNDkuMDg5MyAxOS45Mjg0TTEyLjk1OSA1Mi41OTNDMTIuMTI5OCA1Mi40ODQxIDExLjM2NzUgNTIuMDgwMyAxMC44MTE2IDUxLjQ1NTRMOS44NDU2NyA1MC4zNDA5TDguODc5NzQgNDkuMjI2NEM4LjMyMzg1IDQ4LjYwMTUgOC4wMTE1NiA0Ny43OTczIDggNDYuOTYxVjEzLjU4OEM4IDEyLjc3MzUgOC4zMjM1NyAxMS45OTIzIDguODk5NTIgMTEuNDE2NEM5LjQ3NTQ3IDEwLjg0MDQgMTAuMjU2NiAxMC41MTY4IDExLjA3MTEgMTAuNTE2OEgyMC4yODQ2QzIxLjA5OTEgMTAuNTE2OCAyMS44ODAyIDEwLjg0MDQgMjIuNDU2MiAxMS40MTY0TDI0LjM4OCAxMy42NDU0QzI0Ljk2NCAxNC4yMjE0IDI1LjI4NzUgMTUuMDAyNSAyNS4yODc1IDE1LjgxN1YxNi42NTkxSDQ0Ljg1MzdDNDUuNjY4MiAxNi42NTkxIDQ2LjQ0OTQgMTYuOTgyNyA0Ny4wMjUzIDE3LjU1ODZMNDkuMDg5MyAxOS45Mjg0TTEzLjM5NTUgNTIuNjIyNkw0OC40MjM1IDUyLjY3MDdDNDkuMTAwNSA1Mi42NzA5IDQ5Ljc1ODcgNTIuNDQ3NCA1MC4yOTU2IDUyLjAzNUM1MC44MzI1IDUxLjYyMjUgNTEuMjE4IDUxLjA0NDEgNTEuMzkyMiA1MC4zODk5TDU1Ljg5NjYgMzEuOTYzQzU2LjAxNzcgMzEuNTA4MSA1Ni4wMzI3IDMxLjAzMTUgNTUuOTQwMiAzMC41Njk5QzU1Ljg0NzggMzAuMTA4MiA1NS42NTA1IDI5LjY3NDEgNTUuMzYzNiAyOS4zMDA5QzU1LjIwMzIgMjkuMDkyMiA1NS4wMTcyIDI4LjkwNTggNTQuODEwNSAyOC43NDU1TDUyLjM1MzYgMjYuMTg4NEM1MS45MzEyIDI1Ljk4MDQgNTEuNDY2NyAyNS44NzI0IDUwLjk5NiAyNS44NzI1SDQ5Ljg1NjdWMjEuOTU5M0M0OS44NTY3IDIxLjIwOTMgNDkuNTgyNCAyMC40ODc3IDQ5LjA4OTMgMTkuOTI4NCIgc3Ryb2tlPSIjOTU5NTk3IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPC9zdmc+Cg==" alt="folder" />
                            Select your product requirements document (PDF, Markdown, or other formats)
                        </div>

                        <input class="file" id="file" type="file" accept=".pdf,.md,.json,.yaml,.yml,.txt" multiple>
                    </div>

                    <p class="Regular-body-12 Fg-secondary mt8">
                        Even a draft works — we’ll generate a comprehensive, standardized PRD for you later.
                    </p>

                    <h3 class="Medium-body-14 Fg-default mt20">Uploaded files</h3>

                    <div class="file-list"></div>

                    <div class="file-list-item" id="file-item-tpl">
                        <div class="file-name">CompanyPRD_docs</div>
                        <div class="file-size">3.5MB</div>
                        <button type="button" class="file-delete"></button>
                    </div>
                </div>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px;">
                <button type="reset" class="button reset">Reset</button>
                <button type="submit" id="submit" class="button submit">Continue</button>
            </div>
        </form>
    </div>
</div>

<script>
    const errors = {
        type: false,
        authentication: false,
        port: false,
        files: false,
    }

    function getValueFromQueryParam(key) {
        const params = new URLSearchParams(window.location.search);
        const raw = params.get(key);
        return raw ? decodeURIComponent(raw) : undefined;
    }

    const projectPath = getValueFromQueryParam('project_path');

    function render(config = {}) {
        if (config.type) {
            const modeTabs = document.querySelectorAll('#tab-mode .tabs-content > div');
            modeTabs.forEach(tab => {
                if (tab.innerText.toLowerCase() === config.type) {
                    modeTabs.forEach(t => t.classList.remove('current'));
                    tab.classList.add('current');

                    if (config.type === 'frontend') {
                        document.querySelector('.line-account').style.display = 'block';
                        document.querySelector('.line-backend-authentication').style.display = 'none';
                    }

                    if (config.type === 'backend') {
                        document.querySelector('.line-account').style.display = 'none';
                        document.querySelector('.line-backend-authentication').style.display = 'block';
                    }
                }
            });
        }

        if(config.backendAuthType) {
            console.log(config.backendAuthType);
            document.querySelector('#backendAuthType').value = config.backendAuthType;

            if(config.backendAuthType === 'public') {
                document.querySelector("#tip-type").innerHTML = "Choose this if your backend server doesn’t require authentication to access its endpoints.";
                document.querySelector("#form-item-credential").style.display = 'none';
                document.querySelector("#form-item-username").style.display = 'none';
                document.querySelector("#form-item-password").style.display = 'none';
                document.querySelector("#form-item-api-key").style.display = 'none';
                document.querySelector("#form-item-api-value").style.display = 'none';
            } else if(config.backendAuthType === 'API key') {
                document.querySelector("#tip-type").innerHTML = "Select this if your server expects an API key in request headers.";
                document.querySelector("#form-item-credential").style.display = 'none';
                document.querySelector("#form-item-username").style.display = 'none';
                document.querySelector("#form-item-password").style.display = 'none';
                document.querySelector("#form-item-api-key").style.display = 'flex';
                document.querySelector("#form-item-api-value").style.display = 'flex';
            } else if(config.backendAuthType === 'basic token') {
                document.querySelector("#tip-type").innerHTML = "Select if your backend requires basic auth with username and password.";
                document.querySelector("#form-item-credential").style.display = 'none';
                document.querySelector("#form-item-username").style.display = 'flex';
                document.querySelector("#form-item-password").style.display = 'flex';
                document.querySelector("#form-item-api-key").style.display = 'none';
                document.querySelector("#form-item-api-value").style.display = 'none';
            } else {
                document.querySelector("#tip-type").innerHTML = "Select this if your backend uses bearer tokens in the Authorization header.";
                document.querySelector("#form-item-credential").style.display = 'flex';
                document.querySelector("#form-item-username").style.display = 'none';
                document.querySelector("#form-item-password").style.display = 'none';
                document.querySelector("#form-item-api-key").style.display = 'none';
                document.querySelector("#form-item-api-value").style.display = 'none';
            }
        }

        if(config.backendCredential) {
            document.getElementById('backendCredential').value = config.backendCredential;
        }

        if(config.backendUsername) {
            document.getElementById('backendUsername').value = config.backendUsername;
        }

        if(config.backendPassword) {
            document.getElementById('backendPassword').value = config.backendPassword;
        }

        if(config.backendApiKey) {
            document.getElementById('backendApiKey').value = config.backendApiKey;
        }

        if(config.backendApiValue) {
            document.getElementById('backendApiValue').value = config.backendApiValue;
        }

        // tab: testScope -> Scope
        if (config.scope) {
            const scopeTabs = document.querySelectorAll('#tab-scope .tabs-content > div');
            scopeTabs.forEach(tab => {
                if (tab.dataset.value === config.scope) {
                    tab.classList.add('current');
                } else {
                    tab.classList.remove('current');
                }
            });
        }

        if (config.loginUser) document.getElementById('login_user').value = config.loginUser;
        if (config.loginPassword) document.getElementById('login_password').value = config.loginPassword;

        if (config.localEndpoint) {
            try {
                const url = new URL(config.localEndpoint);
                document.getElementsByName('port')[0].value = url.port || (url.protocol === 'https:' ? '443' : '80');
                let pathname = ""
                if (url.pathname && url.pathname !== "/") {
                    if (url.pathname.startsWith("/")) {
                        pathname = url.pathname.slice(1);
                    } else {
                        pathname = url.pathname;
                    }
                }
                document.getElementsByName('pathname')[0].value = pathname;
            } catch (e) {
                // If endpoint is not a valid URL, use it as is
                document.getElementsByName('port')[0].value = config.localEndpoint;
            }
        }

        if (Array.isArray(config.files) && config.files.length > 0) {
            files = config.files.map(name => ({ name, size: '', id: Math.random().toString(), fromServer: true }));
            initServerFiles = files;
            updateFileList();
        }

        toggleClassName(document.getElementById('tooltip-type'), 'show', errors.type)
        toggleClassName(document.getElementById('tooltip-port'), 'show', errors.port)
        toggleClassName(document.getElementById('tooltip-files'), 'show', errors.files)
        toggleClassName(document.getElementById('tooltip-authentication'), 'show', errors.authentication)
    }

    window.addEventListener('DOMContentLoaded', async () => {
        render({type: "backend", backendAuthType: "public"});

        if (!projectPath) return;
        try {
            const res = await fetch(`/api/config?project_path=${encodeURIComponent(projectPath)}`);
            if (!res.ok) return;
            const config = await res.json();
            render(config)
        } catch (e) { console.error(e) }
    });

    document.getElementById("file").addEventListener("change", async (e) => {
        e.preventDefault();

        // show file names
        Array.from(e.target.files).forEach(file => {
            addFile(file)
        });
    })

    let files = []
    let initServerFiles = []

    // drag file upload
    const fileContainer = document.querySelector('.file-container');

    fileContainer.addEventListener('dragenter', (e) => {
        e.preventDefault();
        e.stopPropagation();
        fileContainer.style.border = '2px dashed #1A7F53';
        fileContainer.style.background = '#23272e';
    });

    fileContainer.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
    });

    fileContainer.addEventListener('dragleave', (e) => {
        e.preventDefault();
        e.stopPropagation();
        fileContainer.style.border = '';
        fileContainer.style.background = '';
    });

    fileContainer.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();
        fileContainer.style.border = '';
        fileContainer.style.background = '';

        if (e.dataTransfer && e.dataTransfer.files) {
            const files = Array.from(e.dataTransfer.files);

            if(!files.every(file => isFileAccepted(file))) {
                alert('File type not accepted');
                return;
            }

            files.forEach(file => {
                addFile(file);
            });
        }
    });

    function getAcceptExts() {
        return (document.getElementById('file').getAttribute('accept') || '')
            .split(',')
            .map(ext => ext.trim().toLowerCase())
            .filter(Boolean);
    }

    function isFileAccepted(file) {
        const acceptExts = getAcceptExts();
        if (acceptExts.length === 0) return true;
        const name = file.name.toLowerCase();
        return acceptExts.some(ext => name.endsWith(ext));
    }

    function addFile(file) {
        files.push(file);
        updateFileList();
    }

    function removeFile(id) {
        const file = files.find(item => item.id === id)
        if(!file) return

        if(file.fromServer) {
            removeFileFromServer(file.name)
        }

        files = files.filter(file => file.id !== id);
        updateFileList()
    }

    function updateFileList() {
        const fileList = document.querySelector('.file-list')
        fileList.innerHTML = "";

        function formatFileSize(bytes) {
            if(!bytes) return '';
            const units = ['B', 'KB', 'MB', 'GB', 'TB'];
            let i = 0;
            while (bytes >= 1024 && i < units.length - 1) {
                bytes /= 1024;
                i++;
            }
            return bytes.toFixed(1) + ' ' + units[i];
        }

        files.forEach(file => {
            const listItem = document.getElementById("file-item-tpl").cloneNode(true);
            file.id = Math.random().toString();
            listItem.id = (`file-item-${file.id}`);
            listItem.querySelector(".file-name").innerText = file.name;
            listItem.querySelector(".file-size").innerText = formatFileSize(file.size);
            fileList.append(listItem);
        })
    }

    function getTabValue(id) {
        return document.getElementById(id).querySelector(".current").dataset.value;
    }


    async function removeFileFromServer(file) {
        return fetch(`/api/file?projectPath=${encodeURIComponent(projectPath)}&file=${encodeURIComponent(file)}`, {
            method: "DELETE",
        }).catch(e => {
            console.error(e);
        })
    }

    function toggleClassName(elm, className, add) {
        if(!elm) return;
        if(add) elm.classList.add(className);
        else elm.classList.remove(className);
    }

    // tabs change
    document.querySelectorAll(".tabs-content > div").forEach(tab => {
        tab.addEventListener("click", (e) => {
            const tabContainer = e.target.closest('.tabs');
            if (tabContainer.id === 'tab-mode') {
                render({ type: e.target.innerHTML.toLowerCase() })
            } else if (tabContainer.id === 'tab-scope') {
                render({ scope: e.target.dataset.value })
            }
        })
    })

    document.getElementById("backendAuthType").addEventListener("change", (e) => {
        render({backendAuthType: e.target.value})
    })

    document.querySelector(".file-list").addEventListener("click", (e) => {
        if (e.target.className !== 'file-delete') return;
        const id = e.target.parentNode.id.substring("file-item-".length)
        removeFile(id)
    })

        document.getElementsByName('port')[0].addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/\D/g, '');
    })

    document.getElementById('form').addEventListener('submit', async function (e) {
        e.preventDefault();
        Object.assign(errors, {files: false, type: false, port: false, authentication: false});
        render({})

        if (files.length === 0) {
            errors.files = true;
        }

        // geather form data
        const formData = new FormData();
        files.forEach(file => formData.append('file', file));

        const mode = getTabValue('tab-mode');
        const scope = getTabValue('tab-scope');
        const loginUser = document.getElementById('login_user').value;
        const loginPassword = document.getElementById('login_password').value;
        const port = document.getElementsByName('port')[0].value;
        const pathname = document.getElementsByName('pathname')[0].value;
        const backendAuthType = document.getElementById('backendAuthType').value;
        const backendCredential = document.getElementById('backendCredential').value;
        const backendUsername = document.getElementById('backendUsername').value;
        const backendPassword = document.getElementById('backendPassword').value;
        const backendApiKey = document.getElementById('backendApiKey').value;
        const backendApiValue = document.getElementById('backendApiValue').value;

        if (!port?.trim()) {
            errors.port = true;
        }

        if (loginUser) formData.append('login_user', loginUser);
        if (loginPassword) formData.append('login_password', loginPassword);
        formData.append('mode', mode)
        formData.append('scope', scope)
        formData.append('port', port)
        if(pathname) {
            formData.append('pathname', pathname)
        }

        if(mode.toLowerCase() === 'backend') {
            if(backendAuthType) formData.append('backendAuthType', backendAuthType)
            if(backendCredential) formData.append('backendCredential', backendCredential)
            if(backendUsername) formData.append('backendUsername', backendUsername)
            if(backendPassword) formData.append('backendPassword', backendPassword)
            if(backendApiKey) formData.append('backendApiKey', backendApiKey)
            if(backendApiValue) formData.append('backendApiValue', backendApiValue)
        }

        // show error info
        if(Object.values(errors).includes(true)) {
            return render({})
        }

        // formData.append('remove_files', initServerFiles.map(file => file.name).join(','))

        // ajax file upload
        try {
            document.getElementById("submit").disabled = true;

            const res = await fetch(`/api/commit?project_path=${encodeURIComponent(projectPath)}`, {
                method: 'POST',
                body: formData
            })

            await res.json()

            alert('upload success, the page will close automatically!');
            window.close();
        } catch (error) {
            alert('upload failed');
            document.getElementById('form').reset();
        } finally {
            document.getElementById("submit").disabled = false;
        }
    });
</script>
</body>

</html>